<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>FamilyChat Pro | Secure Messenger</title>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://unpkg.com/peerjs@1.4.7/dist/peerjs.min.js"></script>

    <style>
        /* --- –°–¢–ò–õ–ò –û–°–¢–ê–Æ–¢–°–Ø –ë–ï–ó –ò–ó–ú–ï–ù–ï–ù–ò–ô --- */
        :root {
            --primary: #00a884;
            --primary-dark: #008f6f;
            --bg-main: #d1d7db;
            --bg-panel: #ffffff;
            --bg-chat: #efeae2;
            --text-main: #111b21;
            --text-sub: #667781;
            --incoming: #ffffff;
            --outgoing: #d9fdd3;
            --danger: #ef5350;
            --success: #25d366;
            --shadow-card: 0 4px 18px rgba(0,0,0,0.1);
            --header-height: 60px;
            --sidebar-width: 380px;
        }

        [data-theme="dark"] {
            --primary: #00a884;
            --primary-dark: #02906f;
            --bg-main: #0b141a;
            --bg-panel: #202c33;
            --bg-chat: #0b141a;
            --text-main: #e9edef;
            --text-sub: #8696a0;
            --incoming: #202c33;
            --outgoing: #005c4b;
            --shadow-card: 0 4px 18px rgba(0,0,0,0.3);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; height: 100dvh; background-color: var(--bg-main); color: var(--text-main); overflow: hidden; }
        button { border: none; outline: none; cursor: pointer; transition: all 0.2s; font-family: inherit; }
        input { font-family: inherit; outline: none; }
        
        .app-wrapper { display: flex; width: 100%; height: 100%; max-width: 1600px; margin: 0 auto; position: relative; background: var(--bg-panel); overflow: hidden; }
        .flex { display: flex; }
        .flex-col { flex-direction: column; }
        .center { align-items: center; justify-content: center; }
        .hidden { display: none !important; }
        .scroll-y { overflow-y: auto; scrollbar-width: thin; }

        /* --- –ê–í–¢–û–†–ò–ó–ê–¶–ò–Ø --- */
        #auth-view { position: absolute; inset: 0; z-index: 2000; background: var(--bg-main); display: flex; align-items: center; justify-content: center; padding: 20px; }
        .auth-card { background: var(--bg-panel); width: 100%; max-width: 450px; padding: 40px; border-radius: 12px; box-shadow: var(--shadow-card); text-align: center; }
        .auth-logo { width: 80px; height: 80px; background: var(--primary); color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 32px; margin: 0 auto 20px; }
        .auth-input { width: 100%; padding: 15px; margin-bottom: 15px; border: 1px solid var(--text-sub); border-radius: 8px; font-size: 16px; background: var(--bg-panel); color: var(--text-main); }
        .btn-primary { width: 100%; padding: 15px; background: var(--primary); color: white; border-radius: 8px; font-weight: 600; font-size: 16px; margin-top: 10px; }
        .btn-primary:active { transform: scale(0.98); }
        .auth-switch { margin-top: 20px; color: var(--primary); cursor: pointer; font-size: 14px; }

        /* --- –°–ü–ò–°–û–ö –ö–û–ù–¢–ê–ö–¢–û–í --- */
        aside { width: var(--sidebar-width); border-right: 1px solid rgba(0,0,0,0.1); display: flex; flex-direction: column; background: var(--bg-panel); z-index: 10; height: 100%; }
        .header { height: var(--header-height); padding: 0 16px; display: flex; align-items: center; justify-content: space-between; background: var(--bg-panel); border-bottom: 1px solid rgba(0,0,0,0.05); }
        .avatar { width: 40px; height: 40px; border-radius: 50%; background: var(--text-sub); color: white; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 18px; object-fit: cover; }
        
        .search-container { padding: 10px; border-bottom: 1px solid rgba(0,0,0,0.05); }
        .search-box { background: rgba(0,0,0,0.05); border-radius: 8px; display: flex; align-items: center; padding: 0 10px; }
        .search-box input { border: none; background: transparent; padding: 10px; flex: 1; color: var(--text-main); }
        
        .contact-list { flex: 1; overflow-y: auto; }
        .contact-item { display: flex; align-items: center; padding: 12px 16px; cursor: pointer; transition: background 0.2s; position: relative; }
        .contact-item:hover { background: rgba(0,0,0,0.03); }
        .contact-item.active { background: rgba(0,0,0,0.06); }
        .contact-info { margin-left: 15px; flex: 1; overflow: hidden; }
        .contact-name { font-weight: 500; font-size: 17px; margin-bottom: 2px; }
        .contact-status { font-size: 13px; color: var(--text-sub); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .unread-badge { background: var(--success); color: white; font-size: 12px; padding: 2px 6px; border-radius: 10px; margin-left: auto; }

        /* --- –ß–ê–¢ --- */
        main { flex: 1; display: flex; flex-direction: column; background: var(--bg-chat); position: relative; height: 100%; }
        main::before { content: ""; position: absolute; inset: 0; opacity: 0.4; background-image: url("data:image/svg+xml,%3Csvg width='100' height='100' viewBox='0 0 100 100' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M11 18c3.866 0 7-3.134 7-7s-3.134-7-7-7-7 3.134-7 7 3.134 7 7 7zm48 25c3.866 0 7-3.134 7-7s-3.134-7-7-7-7 3.134-7 7 3.134 7 7 7zm-43-7c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zm63 31c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zM34 90c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zm56-76c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zM12 86c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm28-65c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm23-11c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm-6 60c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm29 22c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zM32 63c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm57-13c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm-9-21c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM60 91c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM35 41c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM12 60c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2z' fill='%239ca3af' fill-opacity='0.1' fill-rule='evenodd'/%3E%3C/svg%3E"); pointer-events: none; }

        .chat-header { background: var(--bg-panel); height: var(--header-height); padding: 0 16px; display: flex; align-items: center; justify-content: space-between; border-bottom: 1px solid rgba(0,0,0,0.05); z-index: 5; }
        .chat-back-btn { display: none; margin-right: 15px; font-size: 20px; color: var(--text-main); }
        .chat-user-meta { display: flex; align-items: center; cursor: pointer; }
        .chat-actions i { font-size: 20px; color: var(--primary); margin-left: 25px; cursor: pointer; padding: 8px; border-radius: 50%; }
        .chat-actions i:hover { background: rgba(0,0,0,0.05); }

        .messages-container { flex: 1; padding: 20px; overflow-y: auto; display: flex; flex-direction: column; gap: 4px; z-index: 2; }
        .msg { max-width: 65%; padding: 8px 12px; border-radius: 8px; font-size: 15px; line-height: 1.4; position: relative; word-wrap: break-word; box-shadow: 0 1px 2px rgba(0,0,0,0.1); }
        .msg-in { align-self: flex-start; background: var(--incoming); border-top-left-radius: 0; }
        .msg-out { align-self: flex-end; background: var(--outgoing); border-top-right-radius: 0; }
        .msg-time { font-size: 10px; color: var(--text-sub); text-align: right; margin-top: 4px; display: block; float: right; margin-left: 10px; }
        .msg-img { max-width: 100%; border-radius: 6px; margin-bottom: 4px; display: block; cursor: pointer; }

        .input-area { background: var(--bg-panel); padding: 10px 16px; display: flex; align-items: center; gap: 10px; z-index: 5; }
        .input-field { flex: 1; background: rgba(0,0,0,0.05); border-radius: 8px; padding: 12px; max-height: 100px; overflow-y: auto; color: var(--text-main); }
        .btn-icon { color: var(--text-sub); font-size: 22px; padding: 8px; display: flex; align-items: center; justify-content: center; }
        .btn-send { color: var(--primary); }

        /* --- –í–ò–î–ï–û–ó–í–û–ù–ö–ò --- */
        #call-overlay { position: fixed; inset: 0; background: #000; z-index: 3000; display: flex; flex-direction: column; opacity: 0; pointer-events: none; transition: opacity 0.3s; }
        #call-overlay.active { opacity: 1; pointer-events: auto; }
        .video-grid { flex: 1; position: relative; display: flex; align-items: center; justify-content: center; overflow: hidden; }
        video { background: #000; }
        #remote-video { width: 100%; height: 100%; object-fit: contain; }
        #local-video { position: absolute; bottom: 100px; right: 20px; width: 120px; height: 160px; border-radius: 12px; border: 2px solid white; object-fit: cover; box-shadow: 0 4px 12px rgba(0,0,0,0.5); z-index: 3002; transition: all 0.3s; }
        #local-video.dragging { opacity: 0.8; }
        .call-controls { position: absolute; bottom: 30px; left: 0; right: 0; display: flex; justify-content: center; gap: 20px; z-index: 3003; padding-bottom: env(safe-area-inset-bottom); }
        .ctrl-btn { width: 60px; height: 60px; border-radius: 50%; background: rgba(255,255,255,0.2); backdrop-filter: blur(10px); color: white; display: flex; align-items: center; justify-content: center; font-size: 24px; transition: 0.2s; }
        .ctrl-btn:hover { background: rgba(255,255,255,0.3); transform: scale(1.1); }
        .ctrl-btn.bg-red { background: var(--danger); }
        .ctrl-btn.active { background: white; color: #333; }

        .call-status-pill { position: absolute; top: 40px; left: 50%; transform: translateX(-50%); background: rgba(0,0,0,0.6); padding: 8px 20px; border-radius: 30px; color: white; font-size: 14px; z-index: 3003; backdrop-filter: blur(5px); }

        /* --- –ú–û–î–ê–õ –í–•–û–î–Ø–©–ï–ì–û –ó–í–û–ù–ö–ê --- */
        #incoming-modal { position: fixed; top: 20px; left: 50%; transform: translateX(-50%) translateY(-150%); background: rgba(32, 44, 51, 0.95); width: 90%; max-width: 400px; padding: 20px; border-radius: 16px; z-index: 4000; box-shadow: 0 10px 40px rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: space-between; color: white; transition: transform 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); backdrop-filter: blur(10px); }
        #incoming-modal.show { transform: translateX(-50%) translateY(0); }
        .incoming-info { display: flex; align-items: center; gap: 15px; }
        .incoming-actions { display: flex; gap: 15px; }
        .btn-accept { background: var(--success); width: 45px; height: 45px; border-radius: 50%; color: white; display: flex; align-items: center; justify-content: center; font-size: 18px; animation: pulse 1.5s infinite; }
        .btn-decline { background: var(--danger); width: 45px; height: 45px; border-radius: 50%; color: white; display: flex; align-items: center; justify-content: center; font-size: 18px; }

        @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(37, 211, 102, 0.7); } 70% { box-shadow: 0 0 0 10px rgba(37, 211, 102, 0); } 100% { box-shadow: 0 0 0 0 rgba(37, 211, 102, 0); } }

        /* --- –ú–û–ë–ò–õ–¨–ù–ê–Ø –í–ï–†–°–ò–Ø --- */
        @media (max-width: 768px) {
            .app-wrapper { border-radius: 0; box-shadow: none; }
            aside { width: 100%; position: absolute; }
            main { width: 100%; position: absolute; transform: translateX(100%); transition: transform 0.3s ease-in-out; z-index: 20; }
            body.chat-open aside { transform: translateX(-20%); opacity: 0; }
            body.chat-open main { transform: translateX(0); }
            .chat-back-btn { display: block; }
            #local-video { width: 90px; height: 130px; bottom: 120px; right: 15px; }
            .msg { font-size: 16px; }
            #device-selector { display: none !important; }
        }

        /* --- –£–í–ï–î–û–ú–õ–ï–ù–ò–Ø --- */
        #toast-container { position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%); z-index: 5000; text-align: center; width: 100%; pointer-events: none; }
        .toast { display: inline-block; background: #333; color: white; padding: 12px 24px; border-radius: 30px; margin-top: 10px; opacity: 0; transition: 0.3s; transform: translateY(20px); font-size: 14px; box-shadow: 0 4px 12px rgba(0,0,0,0.3); }
        .toast.visible { opacity: 1; transform: translateY(0); }

        /* --- –ò–ù–î–ò–ö–ê–¢–û–† –ó–ê–ì–†–£–ó–ö–ò --- */
        .loader { display: inline-block; width: 20px; height: 20px; border: 3px solid rgba(255,255,255,0.3); border-radius: 50%; border-top-color: white; animation: spin 1s ease-in-out infinite; margin-left: 10px; }
        @keyframes spin { to { transform: rotate(360deg); } }
    </style>
</head>
<body>

    <div id="auth-view">
        <div class="auth-card">
            <div class="auth-logo"><i class="fas fa-users"></i></div>
            <h2 style="margin-bottom: 10px;">FamilyChat</h2>
            <p style="color: var(--text-sub); margin-bottom: 25px;">Connect with your loved ones</p>
            
            <div id="auth-error" style="color: var(--danger); font-size: 14px; margin-bottom: 15px; display: none;"></div>
            
            <input type="text" id="auth-nick" class="auth-input" placeholder="Your Nickname (e.g. Mom)" autocomplete="off">
            <input type="password" id="auth-pass" class="auth-input" placeholder="Password (simple)" autocomplete="new-password">
            
            <button id="btn-auth-action" class="btn-primary" onclick="App.auth.login()">
                Login
                <span class="loader hidden" id="auth-loader"></span>
            </button>
            
            <div class="auth-switch" onclick="App.auth.toggleMode()">
                <span id="auth-switch-text">New here? Create Account</span>
            </div>
        </div>
    </div>

    <div id="app-view" class="app-wrapper hidden">
        
        <aside>
            <div class="header">
                <div class="flex center" style="gap: 12px; cursor: pointer;" onclick="App.ui.showProfileSettings()">
                    <div id="my-avatar" class="avatar"></div>
                    <div style="font-weight: 600;" id="my-nick"></div>
                </div>
                <div class="flex" style="gap: 15px;">
                    <button class="btn-icon" onclick="App.ui.toggleTheme()"><i class="fas fa-adjust"></i></button>
                    <button class="btn-icon" onclick="App.auth.logout()"><i class="fas fa-sign-out-alt"></i></button>
                </div>
            </div>
            
            <div class="search-container">
                <div class="search-box">
                    <i class="fas fa-search" style="color: var(--text-sub);"></i>
                    <input type="text" id="contact-search" placeholder="Search or add by nickname..." onkeyup="if(event.key === 'Enter') App.contacts.searchUser()">
                    <button onclick="App.contacts.searchUser()" style="padding: 8px; color: var(--primary); font-weight: bold;">ADD</button>
                </div>
            </div>

            <div id="contacts-list" class="contact-list"></div>
        </aside>

        <main>
            <div class="chat-header">
                <div class="flex center">
                    <button class="chat-back-btn" onclick="App.ui.closeChat()"><i class="fas fa-arrow-left"></i></button>
                    <div class="chat-user-meta">
                        <div id="chat-avatar" class="avatar" style="width: 36px; height: 36px; margin-right: 10px; font-size: 14px;"></div>
                        <div>
                            <div id="chat-name" style="font-weight: 600; font-size: 16px;"></div>
                            <div id="chat-status" style="font-size: 12px; color: var(--text-sub);">Offline</div>
                        </div>
                    </div>
                </div>
                <div class="chat-actions flex">
                    <i class="fas fa-video" onclick="App.call.startCall()"></i>
                </div>
            </div>

            <div id="messages-area" class="messages-container">
                <div class="center flex flex-col" style="height: 100%; color: var(--text-sub); opacity: 0.6;">
                    <i class="fas fa-comments" style="font-size: 48px; margin-bottom: 20px;"></i>
                    <p>Select a contact to start chatting</p>
                </div>
            </div>

            <div id="input-area" class="input-area hidden">
                <button class="btn-icon" onclick="document.getElementById('file-upload').click()"><i class="fas fa-paperclip"></i></button>
                <input type="file" id="file-upload" hidden onchange="App.chat.handleFileUpload(this)">
                
                <input type="text" id="msg-input" class="input-field" placeholder="Type a message..." onkeydown="if(event.key === 'Enter') App.chat.sendMessage()">
                
                <button class="btn-icon btn-send" onclick="App.chat.sendMessage()"><i class="fas fa-paper-plane"></i></button>
            </div>
        </main>
    </div>

    <div id="incoming-modal">
        <div class="incoming-info">
            <div id="caller-avatar" class="avatar" style="background: white; color: #333;">?</div>
            <div>
                <div style="font-size: 12px; opacity: 0.8;">Incoming Video Call</div>
                <div id="caller-name" style="font-weight: bold; font-size: 18px;">Grandma</div>
            </div>
        </div>
        <div class="incoming-actions">
            <button class="btn-decline" onclick="App.call.rejectCall()"><i class="fas fa-times"></i></button>
            <button class="btn-accept" onclick="App.call.acceptCall()"><i class="fas fa-video"></i></button>
        </div>
    </div>

    <div id="call-overlay">
        <div class="call-status-pill" id="call-status-text">Connecting...</div>
        
        <div class="video-grid">
            <video id="remote-video" autoplay playsinline></video>
            <video id="local-video" autoplay playsinline muted></video>
        </div>

        <div class="call-controls">
            <button class="ctrl-btn" onclick="App.call.toggleAudio()" id="btn-mute"><i class="fas fa-microphone"></i></button>
            <button class="ctrl-btn bg-red" onclick="App.call.endCall()"><i class="fas fa-phone-slash"></i></button>
            <button class="ctrl-btn" onclick="App.call.toggleVideo()" id="btn-cam"><i class="fas fa-video"></i></button>
            <button class="ctrl-btn" onclick="App.call.flipCamera()" id="btn-flip"><i class="fas fa-camera-rotate"></i></button>
        </div>
    </div>

    <div id="toast-container"></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, signOut, updateProfile } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js";
        import { getFirestore, collection, addDoc, query, where, onSnapshot, orderBy, serverTimestamp, doc, setDoc, getDoc, updateDoc, getDocs } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";
        import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-storage.js";

        // üîß –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï #1: –î–æ–±–∞–≤–ª–µ–Ω—ã –ø–µ—Ä–µ–Ω–æ—Å—ã —Å—Ç—Ä–æ–∫
        const firebaseConfig = {
            apiKey: "YOUR_API_KEY",
            authDomain: "YOUR_PROJECT_ID.firebaseapp.com",
            projectId: "YOUR_PROJECT_ID",
            storageBucket: "YOUR_PROJECT_ID.appspot.com",
            messagingSenderId: "SENDER_ID",
            appId: "APP_ID"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const storage = getStorage(app);

        const State = {
            user: null,
            activeContact: null,
            contactsMap: {},
            peer: null,
            currentCall: null,
            localStream: null,
            unsubscribeChat: null,
            isCalling: false,
            callStartTime: null
        };

        // üîß –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï #2: –£–ª—É—á—à–µ–Ω UI Manager
        class UIManager {
            constructor() {
                this.dom = {
                    auth: document.getElementById('auth-view'),
                    app: document.getElementById('app-view'),
                    msgArea: document.getElementById('messages-area'),
                    inputArea: document.getElementById('input-area'),
                    contactList: document.getElementById('contacts-list')
                };
            }

            toast(msg, type = 'info') {
                const container = document.getElementById('toast-container');
                const el = document.createElement('div');
                el.className = 'toast';
                el.textContent = msg;
                if(type === 'error') el.style.background = 'var(--danger)';
                if(type === 'success') el.style.background = 'var(--success)';
                container.appendChild(el);
                requestAnimationFrame(() => {
                    el.classList.add('visible');
                    setTimeout(() => {
                        el.classList.remove('visible');
                        setTimeout(() => el.remove(), 300);
                    }, 4000);
                });
            }

            setLoading(isLoading, elementId = null) {
                if(elementId) {
                    const el = document.getElementById(elementId);
                    if(el) el.style.display = isLoading ? 'inline-block' : 'none';
                }
                document.body.style.cursor = isLoading ? 'wait' : 'default';
            }

            toggleTheme() {
                const body = document.body;
                const current = body.getAttribute('data-theme');
                const next = current === 'dark' ? 'light' : 'dark';
                body.setAttribute('data-theme', next);
                localStorage.setItem('theme', next);
            }

            initTheme() {
                const saved = localStorage.getItem('theme') || 'light';
                document.body.setAttribute('data-theme', saved);
            }

            showApp() {
                this.dom.auth.classList.add('hidden');
                this.dom.app.classList.remove('hidden');
                document.getElementById('my-nick').textContent = State.user.nickname;
                document.getElementById('my-avatar').textContent = State.user.nickname[0].toUpperCase();
            }

            showAuth() {
                this.dom.app.classList.add('hidden');
                this.dom.auth.classList.remove('hidden');
            }

            openChatUI(contact) {
                document.body.classList.add('chat-open');
                document.getElementById('chat-name').textContent = contact.nickname;
                document.getElementById('chat-avatar').textContent = contact.nickname[0].toUpperCase();
                this.dom.inputArea.classList.remove('hidden');
                this.dom.msgArea.innerHTML = '';
            }

            closeChat() {
                document.body.classList.remove('chat-open');
                State.activeContact = null;
                if(State.unsubscribeChat) {
                    State.unsubscribeChat();
                    State.unsubscribeChat = null;
                }
            }

            showProfileSettings() {
                App.ui.toast("Profile settings coming soon!", "info");
            }
        }

        // üîß –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï #3: –ü–æ–ª–Ω–æ—Å—Ç—å—é –ø–µ—Ä–µ–ø–∏—Å–∞–Ω AuthService
        class AuthService {
            constructor() {
                this.isRegistering = false;
            }

            toggleMode() {
                this.isRegistering = !this.isRegistering;
                document.getElementById('btn-auth-action').textContent = this.isRegistering ? 'Create Account' : 'Login';
                document.getElementById('auth-switch-text').textContent = this.isRegistering ? 'Have an account? Login' : 'New here? Create Account';
                document.getElementById('auth-error').style.display = 'none';
            }

            async login() {
                const nick = document.getElementById('auth-nick').value.trim();
                const pass = document.getElementById('auth-pass').value;
                
                if(!nick || !pass) {
                    this.showError("Please fill all fields");
                    return;
                }

                if(nick.length < 2) {
                    this.showError("Nickname must be at least 2 characters");
                    return;
                }

                const email = `${nick.toLowerCase().replace(/[^a-z0-9]/g, '')}@familyconnect.app`;

                try {
                    App.ui.setLoading(true, 'auth-loader');
                    document.getElementById('auth-error').style.display = 'none';

                    if (this.isRegistering) {
                        // –ü—Ä–æ–≤–µ—Ä–∫–∞ —É–Ω–∏–∫–∞–ª—å–Ω–æ—Å—Ç–∏ –Ω–∏–∫–Ω–µ–π–º–∞
                        const q = query(collection(db, "users"), where("nickname", "==", nick));
                        const check = await getDocs(q);
                        if (!check.empty) {
                            throw new Error("Nickname already taken. Choose another one.");
                        }

                        // –°–æ–∑–¥–∞–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                        const cred = await createUserWithEmailAndPassword(auth, email, pass);
                        
                        // –°–æ–∑–¥–∞–Ω–∏–µ –¥–æ–∫—É–º–µ–Ω—Ç–∞ –≤ Firestore
                        await setDoc(doc(db, "users", cred.user.uid), {
                            uid: cred.user.uid,
                            nickname: nick,
                            contacts: [],
                            createdAt: serverTimestamp()
                        });
                        
                        await updateProfile(cred.user, { displayName: nick });
                        App.ui.toast("Account created successfully!", "success");
                    } else {
                        // –í—Ö–æ–¥ –≤ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π –∞–∫–∫–∞—É–Ω—Ç
                        await signInWithEmailAndPassword(auth, email, pass);
                    }
                } catch (e) {
                    this.showError(e.message.replace("Firebase: ", ""));
                } finally {
                    App.ui.setLoading(false, 'auth-loader');
                }
            }

            showError(message) {
                const errDiv = document.getElementById('auth-error');
                errDiv.style.display = 'block';
                errDiv.textContent = message;
            }

            logout() {
                if(App.call.peer) {
                    App.call.peer.destroy();
                }
                signOut(auth).then(() => {
                    window.location.reload();
                });
            }
        }

        // üîß –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï #4: –£–ª—É—á—à–µ–Ω ChatService
        class ChatService {
            async loadContacts() {
                if(!State.user || !State.user.contacts) return;
                const list = document.getElementById('contacts-list');
                list.innerHTML = '';

                if(State.user.contacts.length === 0) {
                    list.innerHTML = '<div style="padding:20px; text-align:center; opacity:0.6;">Search for family members to add them!</div>';
                    return;
                }

                try {
                    // –ó–∞–≥—Ä—É–∑–∫–∞ –∫–æ–Ω—Ç–∞–∫—Ç–æ–≤ –±–∞—Ç—á–∞–º–∏ (–ø–æ 10)
                    const chunks = [];
                    for (let i = 0; i < State.user.contacts.length; i += 10) {
                        chunks.push(State.user.contacts.slice(i, i + 10));
                    }

                    for (const chunk of chunks) {
                        const q = query(collection(db, "users"), where("uid", "in", chunk));
                        const snap = await getDocs(q);
                        snap.forEach(d => {
                            const contact = d.data();
                            State.contactsMap[contact.uid] = contact;
                            this.renderContactItem(contact);
                        });
                    }
                } catch (e) {
                    console.error("Error loading contacts:", e);
                    App.ui.toast("Error loading contacts", "error");
                }
            }

            renderContactItem(contact) {
                const list = document.getElementById('contacts-list');
                const div = document.createElement('div');
                div.className = 'contact-item';
                div.dataset.uid = contact.uid;
                div.innerHTML = `
                    <div class="avatar">${contact.nickname[0].toUpperCase()}</div>
                    <div class="contact-info">
                        <div class="contact-name">${contact.nickname}</div>
                        <div class="contact-status">Tap to chat</div>
                    </div>
                `;
                div.onclick = () => this.startChat(contact);
                list.appendChild(div);
            }

            async searchUser() {
                const input = document.getElementById('contact-search');
                const val = input.value.trim();
                
                if(!val) {
                    App.ui.toast("Enter a nickname to search", "error");
                    return;
                }
                
                if(val === State.user.nickname) {
                    App.ui.toast("That's you!", "error");
                    return;
                }

                App.ui.setLoading(true);
                App.ui.toast("Searching...");

                try {
                    const q = query(collection(db, "users"), where("nickname", "==", val));
                    const snap = await getDocs(q);
                    
                    if(snap.empty) {
                        App.ui.toast("User not found", "error");
                    } else {
                        const newUser = snap.docs[0].data();
                        const myRef = doc(db, "users", State.user.uid);
                        
                        let current = State.user.contacts || [];
                        if(!current.includes(newUser.uid)) {
                            current.push(newUser.uid);
                            await updateDoc(myRef, { contacts: current });
                            State.user.contacts = current;
                            this.renderContactItem(newUser);
                            State.contactsMap[newUser.uid] = newUser;
                            App.ui.toast(`Added ${newUser.nickname} to contacts!`, "success");
                            input.value = '';
                        } else {
                            App.ui.toast("Already in contacts", "info");
                        }
                    }
                } catch (e) {
                    console.error("Search error:", e);
                    App.ui.toast("Search failed", "error");
                } finally {
                    App.ui.setLoading(false);
                }
            }

            startChat(contact) {
                State.activeContact = contact;
                App.ui.openChatUI(contact);

                // –û–±–Ω–æ–≤–ª—è–µ–º –∞–∫—Ç–∏–≤–Ω—ã–π —ç–ª–µ–º–µ–Ω—Ç –≤ —Å–ø–∏—Å–∫–µ
                document.querySelectorAll('.contact-item').forEach(item => {
                    item.classList.remove('active');
                    if(item.dataset.uid === contact.uid) {
                        item.classList.add('active');
                    }
                });

                const chatId = this.getChatId(State.user.uid, contact.uid);
                const q = query(collection(db, "chats", chatId, "messages"), orderBy("createdAt", "asc"));

                if(State.unsubscribeChat) {
                    State.unsubscribeChat();
                }

                State.unsubscribeChat = onSnapshot(q, (snapshot) => {
                    snapshot.docChanges().forEach((change) => {
                        if (change.type === "added") {
                            this.renderMessage(change.doc.data());
                        }
                    });
                });
            }

            getChatId(uid1, uid2) {
                return [uid1, uid2].sort().join("_");
            }

            renderMessage(msg) {
                const isMe = msg.senderId === State.user.uid;
                const div = document.createElement('div');
                div.className = `msg ${isMe ? 'msg-out' : 'msg-in'}`;
                
                let content = `<span>${msg.text || ''}</span>`;
                
                if(msg.type === 'image') {
                    content = `<img src="${msg.fileUrl}" class="msg-img" onclick="window.open('${msg.fileUrl}', '_blank')">` + content;
                } else if (msg.type === 'file') {
                    content = `<a href="${msg.fileUrl}" target="_blank" style="color:var(--primary); text-decoration:none;"><i class="fas fa-file"></i> File</a><br>` + content;
                }

                const date = msg.createdAt ? msg.createdAt.toDate() : new Date();
                const time = date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});

                div.innerHTML = `${content} <span class="msg-time">${time}</span>`;
                
                const area = document.getElementById('messages-area');
                area.appendChild(div);
                area.scrollTop = area.scrollHeight;
            }

            async sendMessage(fileData = null) {
                if(!State.activeContact) return;
                const input = document.getElementById('msg-input');
                const text = input.value.trim();
                
                if(!text && !fileData) return;

                const chatId = this.getChatId(State.user.uid, State.activeContact.uid);
                
                const payload = {
                    text: text,
                    senderId: State.user.uid,
                    createdAt: serverTimestamp(),
                    type: fileData ? fileData.type : 'text',
                    fileUrl: fileData ? fileData.url : null
                };

                try {
                    await addDoc(collection(db, "chats", chatId, "messages"), payload);
                    input.value = '';
                } catch (e) {
                    console.error("Send error:", e);
                    App.ui.toast("Failed to send message", "error");
                }
            }

            async handleFileUpload(input) {
                const file = input.files[0];
                if(!file) return;
                
                App.ui.setLoading(true);
                App.ui.toast("Uploading...");

                try {
                    const storageRef = ref(storage, `chat/${Date.now()}_${file.name.replace(/[^a-zA-Z0-9.]/g, '_')}`);
                    const snap = await uploadBytes(storageRef, file);
                    const url = await getDownloadURL(snap.ref);
                    const type = file.type.startsWith('image/') ? 'image' : 'file';
                    await this.sendMessage({ url, type });
                    App.ui.toast("File sent!", "success");
                } catch(e) {
                    console.error("Upload error:", e);
                    App.ui.toast("Upload failed", "error");
                } finally {
                    App.ui.setLoading(false);
                    input.value = '';
                }
            }
        }

        // üîß –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï #5: –ü–æ–ª–Ω–æ—Å—Ç—å—é –ø–µ—Ä–µ–ø–∏—Å–∞–Ω CallService
        class CallService {
            constructor() {
                this.audioCtx = null;
                this.oscillator = null;
                this.ringInterval = null;
            }

            init() {
                // –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –±–µ–∑–æ–ø–∞—Å–Ω–æ–≥–æ Peer ID
                const safeNick = State.user.nickname.replace(/\W/g, '').substring(0, 20);
                const safeUid = State.user.uid.substring(0, 8);
                const peerId = `${safeNick}_${safeUid}`;
                
                console.log("Initializing PeerJS with ID:", peerId);

                // üîß –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï #6: –î–æ–±–∞–≤–ª–µ–Ω—ã STUN/TURN —Å–µ—Ä–≤–µ—Ä—ã
                this.peer = new Peer(peerId, {
                    config: {
                        iceServers: [
                            { urls: 'stun:stun.l.google.com:19302' },
                            { urls: 'stun:stun1.l.google.com:19302' },
                            { urls: 'turn:openrelay.metered.ca:443', username: 'openrelayproject', credential: 'openrelayproject' }
                        ]
                    },
                    debug: 2 // –í–∫–ª—é—á–∞–µ–º –¥–µ–±–∞–≥ –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏
                });

                this.peer.on('open', (id) => {
                    console.log('‚úÖ Peer connected with ID:', id);
                    App.ui.toast("Ready for calls", "success");
                });

                this.peer.on('call', (call) => {
                    console.log("üìû Incoming call from:", call.peer);
                    this.handleIncomingCall(call);
                });

                this.peer.on('error', (err) => {
                    console.error('‚ùå PeerJS Error:', err);
                    App.ui.toast(`Connection Error: ${err.type}`, 'error');
                    this.endCall();
                });

                this.peer.on('disconnected', () => {
                    console.warn("‚ö†Ô∏è Peer disconnected");
                    App.ui.toast("Connection lost. Reconnecting...", "warning");
                    this.peer.reconnect();
                });
            }

            playRing(type = 'incoming') {
                if (!this.audioCtx) {
                    this.audioCtx = new (window.AudioContext || window.webkitAudioContext)();
                }
                this.stopRing();

                this.oscillator = this.audioCtx.createOscillator();
                const gainNode = this.audioCtx.createGain();

                this.oscillator.connect(gainNode);
                gainNode.connect(this.audioCtx.destination);

                if (type === 'incoming') {
                    this.oscillator.type = 'sine';
                    this.oscillator.frequency.setValueAtTime(800, this.audioCtx.currentTime);
                    gainNode.gain.setValueAtTime(0, this.audioCtx.currentTime);
                    
                    const now = this.audioCtx.currentTime;
                    gainNode.gain.linearRampToValueAtTime(0.5, now + 0.1);
                    gainNode.gain.linearRampToValueAtTime(0, now + 2);
                    
                    this.oscillator.start(now);
                    this.oscillator.stop(now + 2);
                    
                    this.ringInterval = setInterval(() => {
                         const osc = this.audioCtx.createOscillator();
                         const gn = this.audioCtx.createGain();
                         osc.connect(gn);
                         gn.connect(this.audioCtx.destination);
                         osc.frequency.setValueAtTime(800, this.audioCtx.currentTime);
                         gn.gain.setValueAtTime(0, this.audioCtx.currentTime);
                         gn.gain.linearRampToValueAtTime(0.5, this.audioCtx.currentTime + 0.1);
                         gn.gain.linearRampToValueAtTime(0, this.audioCtx.currentTime + 2);
                         osc.start();
                         osc.stop(this.audioCtx.currentTime + 2);
                    }, 3000);

                } else if (type === 'dialing') {
                    this.oscillator.frequency.setValueAtTime(400, this.audioCtx.currentTime);
                    gainNode.gain.value = 0.1;
                    this.oscillator.start();
                }
            }

            stopRing() {
                if (this.oscillator) {
                    try { this.oscillator.stop(); } catch(e){}
                    this.oscillator = null;
                }
                if (this.ringInterval) {
                    clearInterval(this.ringInterval);
                    this.ringInterval = null;
                }
            }

            async getStream() {
                try {
                    // üîß –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï #7: –£–ª—É—á—à–µ–Ω–æ –ø–æ–ª—É—á–µ–Ω–∏–µ –≤–∏–¥–µ–æ–ø–æ—Ç–æ–∫–∞
                    const constraints = {
                        video: {
                            width: { ideal: 1280, max: 1920 },
                            height: { ideal: 720, max: 1080 },
                            facingMode: 'user'
                        },
                        audio: {
                            echoCancellation: true,
                            noiseSuppression: true,
                            autoGainControl: true
                        }
                    };

                    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ–¥–¥–µ—Ä–∂–∫—É getUserMedia
                    if(!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                        throw new Error("Your browser doesn't support camera access");
                    }

                    const stream = await navigator.mediaDevices.getUserMedia(constraints);
                    State.localStream = stream;
                    const localVideo = document.getElementById('local-video');
                    localVideo.srcObject = stream;
                    
                    // –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ —Ç—Ä–µ–∫–æ–≤
                    stream.getTracks().forEach(track => {
                        track.onended = () => {
                            console.log("Track ended:", track.kind);
                            if(State.currentCall) {
                                this.endCall();
                            }
                        };
                    });

                    return stream;
                } catch (e) {
                    console.error("Stream error:", e);
                    let errorMsg = "Camera Access Denied";
                    if(e.name === 'NotFoundError') errorMsg = "No camera/microphone found";
                    if(e.name === 'NotAllowedError') errorMsg = "Please allow camera access";
                    if(e.name === 'OverconstrainedError') errorMsg = "Camera resolution not supported";
                    
                    App.ui.toast(errorMsg, 'error');
                    throw e;
                }
            }

            handleIncomingCall(call) {
                if (State.currentCall) {
                    console.log("Busy, rejecting call");
                    call.close(); 
                    return;
                }
                
                this.tempCall = call;
                
                // –ü–∞—Ä—Å–∏–º –∏–º—è –≤—ã–∑—ã–≤–∞—é—â–µ–≥–æ
                const callerRaw = call.peer.split('_')[0] || 'Unknown';
                document.getElementById('caller-name').innerText = callerRaw;
                document.getElementById('caller-avatar').innerText = callerRaw[0]?.toUpperCase() || '?';
                
                document.getElementById('incoming-modal').classList.add('show');
                this.playRing('incoming');
                
                // –ê–≤—Ç–æ–æ—Ç–∫–ª–æ–Ω–µ–Ω–∏–µ —á–µ—Ä–µ–∑ 30 —Å–µ–∫—É–Ω–¥
                this.incomingTimeout = setTimeout(() => {
                    if(this.tempCall) {
                        this.rejectCall();
                        App.ui.toast("Call missed", "warning");
                    }
                }, 30000);
            }

            async acceptCall() {
                clearTimeout(this.incomingTimeout);
                this.stopRing();
                document.getElementById('incoming-modal').classList.remove('show');
                
                try {
                    const stream = await this.getStream();
                    this.tempCall.answer(stream);
                    this.setupCallEvents(this.tempCall);
                    App.ui.toast("Call accepted", "success");
                } catch (e) {
                    console.error("Accept call error:", e);
                    this.rejectCall();
                    App.ui.toast("Failed to accept call", "error");
                }
            }

            rejectCall() {
                clearTimeout(this.incomingTimeout);
                this.stopRing();
                document.getElementById('incoming-modal').classList.remove('show');
                if(this.tempCall) {
                    this.tempCall.close();
                    this.tempCall = null;
                }
            }

            async startCall() {
                if(!State.activeContact) {
                    App.ui.toast("Select a contact first", "error");
                    return;
                }
                
                // –ì–µ–Ω–µ—Ä–∞—Ü–∏—è Peer ID –¥–ª—è –≤—ã–∑—ã–≤–∞–µ–º–æ–≥–æ
                const targetNick = State.activeContact.nickname.replace(/\W/g, '').substring(0, 20);
                const targetUid = State.activeContact.uid.substring(0, 8);
                const targetPeerId = `${targetNick}_${targetUid}`;
                
                console.log("Calling peer:", targetPeerId);

                try {
                    const stream = await this.getStream();
                    document.getElementById('call-overlay').classList.add('active');
                    document.getElementById('call-status-text').style.display = 'block';
                    document.getElementById('call-status-text').innerText = "Dialing...";
                    this.playRing('dialing');

                    // üîß –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï #8: –î–æ–±–∞–≤–ª–µ–Ω —Ç–∞–π–º–∞—É—Ç –≤—ã–∑–æ–≤–∞
                    const call = this.peer.call(targetPeerId, stream);
                    
                    // –¢–∞–π–º–∞—É—Ç –Ω–∞ —É—Å—Ç–∞–Ω–æ–≤–∫—É —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è
                    this.callTimeout = setTimeout(() => {
                        if(!State.currentCall) {
                            App.ui.toast("No answer", "warning");
                            this.endCall();
                        }
                    }, 30000);

                    this.setupCallEvents(call);

                } catch(e) {
                    console.error("Start call error:", e);
                    App.ui.toast("Failed to start call", "error");
                    this.endCall();
                }
            }

            setupCallEvents(call) {
                State.currentCall = call;
                State.callStartTime = Date.now();
                
                call.on('stream', (remoteStream) => {
                    clearTimeout(this.callTimeout);
                    this.stopRing();
                    document.getElementById('call-status-text').innerText = "Connected";
                    setTimeout(() => document.getElementById('call-status-text').style.display = 'none', 2000);
                    
                    const remoteVideo = document.getElementById('remote-video');
                    remoteVideo.srcObject = remoteStream;
                    
                    // –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ —É–¥–∞–ª–µ–Ω–Ω–æ–≥–æ –ø–æ—Ç–æ–∫–∞
                    remoteStream.getTracks().forEach(track => {
                        track.onended = () => {
                            console.log("Remote track ended");
                            this.endCall();
                        };
                    });
                });

                call.on('close', () => {
                    console.log("Call closed");
                    this.endCall();
                });

                call.on('error', (err) => {
                    console.error("Call error:", err);
                    App.ui.toast("Call error occurred", "error");
                    this.endCall();
                });

                // ICE candidate handling
                if(call.peerConnection) {
                    call.peerConnection.oniceconnectionstatechange = () => {
                        console.log("ICE state:", call.peerConnection.iceConnectionState);
                        if(call.peerConnection.iceConnectionState === 'failed' || 
                           call.peerConnection.iceConnectionState === 'disconnected') {
                            App.ui.toast("Connection unstable", "warning");
                        }
                    };
                }
            }

            endCall() {
                clearTimeout(this.callTimeout);
                clearTimeout(this.incomingTimeout);
                this.stopRing();
                
                if (State.currentCall) {
                    State.currentCall.close();
                    State.currentCall = null;
                }
                
                if (State.localStream) {
                    State.localStream.getTracks().forEach(t => {
                        try {
                            t.stop();
                        } catch(e) {
                            console.log("Error stopping track:", e);
                        }
                    });
                }
                
                State.localStream = null;
                State.callStartTime = null;
                
                document.getElementById('call-overlay').classList.remove('active');
                document.getElementById('remote-video').srcObject = null;
                document.getElementById('local-video').srcObject = null;
                document.getElementById('call-status-text').style.display = 'block';
                
                // –°–±—Ä–æ—Å –∫–Ω–æ–ø–æ–∫ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è
                document.getElementById('btn-mute').style.background = 'rgba(255,255,255,0.2)';
                document.getElementById('btn-mute').innerHTML = '<i class="fas fa-microphone"></i>';
                document.getElementById('btn-cam').style.background = 'rgba(255,255,255,0.2)';
                document.getElementById('btn-cam').innerHTML = '<i class="fas fa-video"></i>';
            }

            toggleAudio() {
                if(!State.localStream) return;
                const track = State.localStream.getAudioTracks()[0];
                if(!track) return;
                
                track.enabled = !track.enabled;
                const btn = document.getElementById('btn-mute');
                btn.style.background = track.enabled ? 'rgba(255,255,255,0.2)' : 'var(--danger)';
                btn.innerHTML = track.enabled ? '<i class="fas fa-microphone"></i>' : '<i class="fas fa-microphone-slash"></i>';
            }

            toggleVideo() {
                if(!State.localStream) return;
                const track = State.localStream.getVideoTracks()[0];
                if(!track) return;
                
                track.enabled = !track.enabled;
                const btn = document.getElementById('btn-cam');
                btn.style.background = track.enabled ? 'rgba(255,255,255,0.2)' : 'var(--danger)';
                btn.innerHTML = track.enabled ? '<i class="fas fa-video"></i>' : '<i class="fas fa-video-slash"></i>';
            }

            async flipCamera() {
                if(!State.localStream) return;
                
                const currentTrack = State.localStream.getVideoTracks()[0];
                const currentSettings = currentTrack?.getSettings() || {};
                const currentMode = currentSettings.facingMode || 'user';
                const newMode = currentMode === 'user' ? 'environment' : 'user';
                
                try {
                    const newStream = await navigator.mediaDevices.getUserMedia({
                        video: { facingMode: newMode },
                        audio: true
                    });
                    
                    const videoTrack = newStream.getVideoTracks()[0];
                    
                    // –ó–∞–º–µ–Ω—è–µ–º —Ç—Ä–µ–∫ –≤ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–∏
                    if(State.currentCall && State.currentCall.peerConnection) {
                        const sender = State.currentCall.peerConnection.getSenders().find(s => s.track && s.track.kind === 'video');
                        if(sender) {
                            await sender.replaceTrack(videoTrack);
                        }
                    }
                    
                    document.getElementById('local-video').srcObject = newStream;
                    State.localStream.getTracks().forEach(t => t.stop());
                    State.localStream = newStream;
                    
                } catch(e) {
                    console.error("Camera switch error:", e);
                    App.ui.toast("Cannot switch camera", "error");
                }
            }
        }

        // –ì–ª–∞–≤–Ω–æ–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
        const App = {
            auth: new AuthService(),
            chat: new ChatService(),
            call: new CallService(),
            ui: new UIManager(),
            contacts: null // –ë—É–¥–µ—Ç —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ –Ω–∏–∂–µ
        };
        App.contacts = App.chat; // –ü–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º ChatService

        window.App = App;

        // Firebase Auth Listener
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                try {
                    const userDoc = await getDoc(doc(db, "users", user.uid));
                    if(userDoc.exists()) {
                        State.user = userDoc.data();
                        App.ui.showApp();
                        await App.chat.loadContacts();
                        App.call.init();
                        App.ui.initTheme();
                    } else {
                        // –ï—Å–ª–∏ –¥–æ–∫—É–º–µ–Ω—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –Ω–µ –Ω–∞–π–¥–µ–Ω, —Å–æ–∑–¥–∞–µ–º –µ–≥–æ
                        await setDoc(doc(db, "users", user.uid), {
                            uid: user.uid,
                            nickname: user.displayName || "User",
                            contacts: [],
                            createdAt: serverTimestamp()
                        });
                        window.location.reload();
                    }
                } catch (e) {
                    console.error("Auth state error:", e);
                    App.ui.toast("Error loading user data", "error");
                }
            } else {
                State.user = null;
                App.ui.showAuth();
            }
        });

        // üîß –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï #9: –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–¥–µ—Ä–∂–∫–∏ WebRTC
        window.addEventListener('load', () => {
            if(!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                App.ui.toast("Your browser doesn't support video calls", "error");
            }
        });
    </script>
</body>
</html>
