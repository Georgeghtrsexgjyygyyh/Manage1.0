<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>FamilyChat Pro | Secure Messenger</title>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://unpkg.com/peerjs@1.4.7/dist/peerjs.min.js"></script>

    <style>
        /* --- 1. CORE VARIABLES & RESET --- */
        :root {
            /* Colors - Light Mode */
            --primary: #00a884;
            --primary-dark: #008f6f;
            --bg-main: #d1d7db;
            --bg-panel: #ffffff;
            --bg-chat: #efeae2;
            --text-main: #111b21;
            --text-sub: #667781;
            --incoming: #ffffff;
            --outgoing: #d9fdd3;
            --danger: #ef5350;
            --success: #25d366;
            --shadow-card: 0 4px 18px rgba(0,0,0,0.1);
            
            /* Dimensions */
            --header-height: 60px;
            --sidebar-width: 380px;
        }

        [data-theme="dark"] {
            --primary: #00a884;
            --primary-dark: #02906f;
            --bg-main: #0b141a;
            --bg-panel: #202c33;
            --bg-chat: #0b141a; /* Dark chat background */
            --text-main: #e9edef;
            --text-sub: #8696a0;
            --incoming: #202c33;
            --outgoing: #005c4b;
            --shadow-card: 0 4px 18px rgba(0,0,0,0.3);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; height: 100dvh; background-color: var(--bg-main); color: var(--text-main); overflow: hidden; }
        
        button { border: none; outline: none; cursor: pointer; transition: all 0.2s; font-family: inherit; }
        input { font-family: inherit; outline: none; }
        
        /* --- 2. LAYOUT UTILITIES --- */
        .app-wrapper { display: flex; width: 100%; height: 100%; max-width: 1600px; margin: 0 auto; position: relative; background: var(--bg-panel); overflow: hidden; }
        .flex { display: flex; }
        .flex-col { flex-direction: column; }
        .center { align-items: center; justify-content: center; }
        .hidden { display: none !important; }
        .scroll-y { overflow-y: auto; scrollbar-width: thin; }

        /* --- 3. AUTH SCREEN --- */
        #auth-view { position: absolute; inset: 0; z-index: 2000; background: var(--bg-main); display: flex; align-items: center; justify-content: center; padding: 20px; }
        .auth-card { background: var(--bg-panel); width: 100%; max-width: 450px; padding: 40px; border-radius: 12px; box-shadow: var(--shadow-card); text-align: center; }
        .auth-logo { width: 80px; height: 80px; background: var(--primary); color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 32px; margin: 0 auto 20px; }
        .auth-input { width: 100%; padding: 15px; margin-bottom: 15px; border: 1px solid var(--text-sub); border-radius: 8px; font-size: 16px; background: var(--bg-panel); color: var(--text-main); }
        .btn-primary { width: 100%; padding: 15px; background: var(--primary); color: white; border-radius: 8px; font-weight: 600; font-size: 16px; margin-top: 10px; }
        .btn-primary:active { transform: scale(0.98); }
        .auth-switch { margin-top: 20px; color: var(--primary); cursor: pointer; font-size: 14px; }

        /* --- 4. SIDEBAR (CONTACTS) --- */
        aside { width: var(--sidebar-width); border-right: 1px solid rgba(0,0,0,0.1); display: flex; flex-direction: column; background: var(--bg-panel); z-index: 10; height: 100%; }
        .header { height: var(--header-height); padding: 0 16px; display: flex; align-items: center; justify-content: space-between; background: var(--bg-panel); border-bottom: 1px solid rgba(0,0,0,0.05); }
        .avatar { width: 40px; height: 40px; border-radius: 50%; background: var(--text-sub); color: white; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 18px; object-fit: cover; }
        
        .search-container { padding: 10px; border-bottom: 1px solid rgba(0,0,0,0.05); }
        .search-box { background: rgba(0,0,0,0.05); border-radius: 8px; display: flex; align-items: center; padding: 0 10px; }
        .search-box input { border: none; background: transparent; padding: 10px; flex: 1; color: var(--text-main); }
        
        .contact-list { flex: 1; overflow-y: auto; }
        .contact-item { display: flex; align-items: center; padding: 12px 16px; cursor: pointer; transition: background 0.2s; position: relative; }
        .contact-item:hover { background: rgba(0,0,0,0.03); }
        .contact-item.active { background: rgba(0,0,0,0.06); }
        .contact-info { margin-left: 15px; flex: 1; overflow: hidden; }
        .contact-name { font-weight: 500; font-size: 17px; margin-bottom: 2px; }
        .contact-status { font-size: 13px; color: var(--text-sub); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .unread-badge { background: var(--success); color: white; font-size: 12px; padding: 2px 6px; border-radius: 10px; margin-left: auto; }

        /* --- 5. CHAT AREA --- */
        main { flex: 1; display: flex; flex-direction: column; background: var(--bg-chat); position: relative; height: 100%; }
        /* Background Pattern */
        main::before { content: ""; position: absolute; inset: 0; opacity: 0.4; background-image: url("data:image/svg+xml,%3Csvg width='100' height='100' viewBox='0 0 100 100' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M11 18c3.866 0 7-3.134 7-7s-3.134-7-7-7-7 3.134-7 7 3.134 7 7 7zm48 25c3.866 0 7-3.134 7-7s-3.134-7-7-7-7 3.134-7 7 3.134 7 7 7zm-43-7c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zm63 31c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zM34 90c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zm56-76c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zM12 86c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm28-65c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm23-11c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm-6 60c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm29 22c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zM32 63c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm57-13c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm-9-21c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM60 91c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM35 41c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM12 60c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2z' fill='%239ca3af' fill-opacity='0.1' fill-rule='evenodd'/%3E%3C/svg%3E"); pointer-events: none; }

        .chat-header { background: var(--bg-panel); height: var(--header-height); padding: 0 16px; display: flex; align-items: center; justify-content: space-between; border-bottom: 1px solid rgba(0,0,0,0.05); z-index: 5; }
        .chat-back-btn { display: none; margin-right: 15px; font-size: 20px; color: var(--text-main); }
        .chat-user-meta { display: flex; align-items: center; cursor: pointer; }
        .chat-actions i { font-size: 20px; color: var(--primary); margin-left: 25px; cursor: pointer; padding: 8px; border-radius: 50%; }
        .chat-actions i:hover { background: rgba(0,0,0,0.05); }

        .messages-container { flex: 1; padding: 20px; overflow-y: auto; display: flex; flex-direction: column; gap: 4px; z-index: 2; }
        
        .msg { max-width: 65%; padding: 8px 12px; border-radius: 8px; font-size: 15px; line-height: 1.4; position: relative; word-wrap: break-word; box-shadow: 0 1px 2px rgba(0,0,0,0.1); }
        .msg-in { align-self: flex-start; background: var(--incoming); border-top-left-radius: 0; }
        .msg-out { align-self: flex-end; background: var(--outgoing); border-top-right-radius: 0; }
        .msg-time { font-size: 10px; color: var(--text-sub); text-align: right; margin-top: 4px; display: block; float: right; margin-left: 10px; }
        .msg-img { max-width: 100%; border-radius: 6px; margin-bottom: 4px; display: block; cursor: pointer; }

        .input-area { background: var(--bg-panel); padding: 10px 16px; display: flex; align-items: center; gap: 10px; z-index: 5; }
        .input-field { flex: 1; background: rgba(0,0,0,0.05); border-radius: 8px; padding: 12px; max-height: 100px; overflow-y: auto; color: var(--text-main); }
        .btn-icon { color: var(--text-sub); font-size: 22px; padding: 8px; display: flex; align-items: center; justify-content: center; }
        .btn-send { color: var(--primary); }

        /* --- 6. VIDEO CALL OVERLAY --- */
        #call-overlay { position: fixed; inset: 0; background: #000; z-index: 3000; display: flex; flex-direction: column; opacity: 0; pointer-events: none; transition: opacity 0.3s; }
        #call-overlay.active { opacity: 1; pointer-events: auto; }
        
        .video-grid { flex: 1; position: relative; display: flex; align-items: center; justify-content: center; overflow: hidden; }
        video { background: #000; }
        #remote-video { width: 100%; height: 100%; object-fit: contain; }
        #local-video { position: absolute; bottom: 100px; right: 20px; width: 120px; height: 160px; border-radius: 12px; border: 2px solid white; object-fit: cover; box-shadow: 0 4px 12px rgba(0,0,0,0.5); z-index: 3002; transition: all 0.3s; }
        
        /* Dragging local video on desktop */
        #local-video.dragging { opacity: 0.8; }

        .call-controls { position: absolute; bottom: 30px; left: 0; right: 0; display: flex; justify-content: center; gap: 20px; z-index: 3003; padding-bottom: env(safe-area-inset-bottom); }
        .ctrl-btn { width: 60px; height: 60px; border-radius: 50%; background: rgba(255,255,255,0.2); backdrop-filter: blur(10px); color: white; display: flex; align-items: center; justify-content: center; font-size: 24px; transition: 0.2s; }
        .ctrl-btn:hover { background: rgba(255,255,255,0.3); transform: scale(1.1); }
        .ctrl-btn.bg-red { background: var(--danger); }
        .ctrl-btn.active { background: white; color: #333; }

        .call-status-pill { position: absolute; top: 40px; left: 50%; transform: translateX(-50%); background: rgba(0,0,0,0.6); padding: 8px 20px; border-radius: 30px; color: white; font-size: 14px; z-index: 3003; backdrop-filter: blur(5px); }

        /* --- 7. INCOMING CALL MODAL --- */
        #incoming-modal { position: fixed; top: 20px; left: 50%; transform: translateX(-50%) translateY(-150%); background: rgba(32, 44, 51, 0.95); width: 90%; max-width: 400px; padding: 20px; border-radius: 16px; z-index: 4000; box-shadow: 0 10px 40px rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: space-between; color: white; transition: transform 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); backdrop-filter: blur(10px); }
        #incoming-modal.show { transform: translateX(-50%) translateY(0); }
        .incoming-info { display: flex; align-items: center; gap: 15px; }
        .incoming-actions { display: flex; gap: 15px; }
        .btn-accept { background: var(--success); width: 45px; height: 45px; border-radius: 50%; color: white; display: flex; align-items: center; justify-content: center; font-size: 18px; animation: pulse 1.5s infinite; }
        .btn-decline { background: var(--danger); width: 45px; height: 45px; border-radius: 50%; color: white; display: flex; align-items: center; justify-content: center; font-size: 18px; }

        @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(37, 211, 102, 0.7); } 70% { box-shadow: 0 0 0 10px rgba(37, 211, 102, 0); } 100% { box-shadow: 0 0 0 0 rgba(37, 211, 102, 0); } }

        /* --- 8. MOBILE RESPONSIVE --- */
        @media (max-width: 768px) {
            .app-wrapper { border-radius: 0; box-shadow: none; }
            aside { width: 100%; position: absolute; }
            main { width: 100%; position: absolute; transform: translateX(100%); transition: transform 0.3s ease-in-out; z-index: 20; }
            
            body.chat-open aside { transform: translateX(-20%); opacity: 0; }
            body.chat-open main { transform: translateX(0); }
            
            .chat-back-btn { display: block; }
            
            #local-video { width: 90px; height: 130px; bottom: 120px; right: 15px; }
            .msg { font-size: 16px; } /* Larger text for reading */
            
            /* Hide device selection on mobile to simplify */
            #device-selector { display: none !important; }
        }

        /* --- 9. TOAST --- */
        #toast-container { position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%); z-index: 5000; text-align: center; width: 100%; pointer-events: none; }
        .toast { display: inline-block; background: #333; color: white; padding: 12px 24px; border-radius: 30px; margin-top: 10px; opacity: 0; transition: 0.3s; transform: translateY(20px); font-size: 14px; box-shadow: 0 4px 12px rgba(0,0,0,0.3); }
        .toast.visible { opacity: 1; transform: translateY(0); }
    </style>
</head>
<body>

    <div id="auth-view">
        <div class="auth-card">
            <div class="auth-logo"><i class="fas fa-users"></i></div>
            <h2 style="margin-bottom: 10px;">FamilyChat</h2>
            <p style="color: var(--text-sub); margin-bottom: 25px;">Connect with your loved ones</p>
            
            <div id="auth-error" style="color: var(--danger); font-size: 14px; margin-bottom: 15px; display: none;"></div>
            
            <input type="text" id="auth-nick" class="auth-input" placeholder="Your Nickname (e.g. Mom)" autocomplete="off">
            <input type="password" id="auth-pass" class="auth-input" placeholder="Password (simple)" autocomplete="new-password">
            
            <button id="btn-auth-action" class="btn-primary" onclick="App.auth.login()">Login</button>
            
            <div class="auth-switch" onclick="App.auth.toggleMode()">
                <span id="auth-switch-text">New here? Create Account</span>
            </div>
        </div>
    </div>

    <div id="app-view" class="app-wrapper hidden">
        
        <aside>
            <div class="header">
                <div class="flex center" style="gap: 12px; cursor: pointer;" onclick="App.ui.showProfileSettings()">
                    <div id="my-avatar" class="avatar"></div>
                    <div style="font-weight: 600;" id="my-nick"></div>
                </div>
                <div class="flex" style="gap: 15px;">
                    <button class="btn-icon" onclick="App.ui.toggleTheme()"><i class="fas fa-adjust"></i></button>
                    <button class="btn-icon" onclick="App.auth.logout()"><i class="fas fa-sign-out-alt"></i></button>
                </div>
            </div>
            
            <div class="search-container">
                <div class="search-box">
                    <i class="fas fa-search" style="color: var(--text-sub);"></i>
                    <input type="text" id="contact-search" placeholder="Search or add by nickname..." onkeyup="if(event.key === 'Enter') App.contacts.searchUser()">
                    <button onclick="App.contacts.searchUser()" style="padding: 8px; color: var(--primary); font-weight: bold;">ADD</button>
                </div>
            </div>

            <div id="contacts-list" class="contact-list">
                </div>
        </aside>

        <main>
            <div class="chat-header">
                <div class="flex center">
                    <button class="chat-back-btn" onclick="App.ui.closeChat()"><i class="fas fa-arrow-left"></i></button>
                    <div class="chat-user-meta">
                        <div id="chat-avatar" class="avatar" style="width: 36px; height: 36px; margin-right: 10px; font-size: 14px;"></div>
                        <div>
                            <div id="chat-name" style="font-weight: 600; font-size: 16px;"></div>
                            <div id="chat-status" style="font-size: 12px; color: var(--text-sub);">Offline</div>
                        </div>
                    </div>
                </div>
                <div class="chat-actions flex">
                    <i class="fas fa-video" onclick="App.call.startCall()"></i>
                </div>
            </div>

            <div id="messages-area" class="messages-container">
                <div class="center flex flex-col" style="height: 100%; color: var(--text-sub); opacity: 0.6;">
                    <i class="fas fa-comments" style="font-size: 48px; margin-bottom: 20px;"></i>
                    <p>Select a contact to start chatting</p>
                </div>
            </div>

            <div id="input-area" class="input-area hidden">
                <button class="btn-icon" onclick="document.getElementById('file-upload').click()"><i class="fas fa-paperclip"></i></button>
                <input type="file" id="file-upload" hidden onchange="App.chat.handleFileUpload(this)">
                
                <input type="text" id="msg-input" class="input-field" placeholder="Type a message..." onkeydown="if(event.key === 'Enter') App.chat.sendMessage()">
                
                <button class="btn-icon btn-send" onclick="App.chat.sendMessage()"><i class="fas fa-paper-plane"></i></button>
            </div>
        </main>
    </div>

    <div id="incoming-modal">
        <div class="incoming-info">
            <div id="caller-avatar" class="avatar" style="background: white; color: #333;">?</div>
            <div>
                <div style="font-size: 12px; opacity: 0.8;">Incoming Video Call</div>
                <div id="caller-name" style="font-weight: bold; font-size: 18px;">Grandma</div>
            </div>
        </div>
        <div class="incoming-actions">
            <button class="btn-decline" onclick="App.call.rejectCall()"><i class="fas fa-times"></i></button>
            <button class="btn-accept" onclick="App.call.acceptCall()"><i class="fas fa-video"></i></button>
        </div>
    </div>

    <div id="call-overlay">
        <div class="call-status-pill" id="call-status-text">Connecting...</div>
        
        <div class="video-grid">
            <video id="remote-video" autoplay playsinline></video>
            <video id="local-video" autoplay playsinline muted></video>
        </div>

        <div class="call-controls">
            <button class="ctrl-btn" onclick="App.call.toggleAudio()" id="btn-mute"><i class="fas fa-microphone"></i></button>
            <button class="ctrl-btn bg-red" onclick="App.call.endCall()"><i class="fas fa-phone-slash"></i></button>
            <button class="ctrl-btn" onclick="App.call.toggleVideo()" id="btn-cam"><i class="fas fa-video"></i></button>
            <button class="ctrl-btn" onclick="App.call.flipCamera()" id="btn-flip"><i class="fas fa-camera-rotate"></i></button>
        </div>
    </div>

    <div id="toast-container"></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, signOut, updateProfile } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js";
        import { getFirestore, collection, addDoc, query, where, onSnapshot, orderBy, serverTimestamp, doc, setDoc, getDoc, updateDoc } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";
        import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-storage.js";

        /**
         * ------------------------------------------------------------------
         * CONFIGURATION
         * Replace this object with your Firebase Console credentials
         * ------------------------------------------------------------------
         */
        // For Firebase JS SDK v7.20.0 and later, measurementId is optional
const firebaseConfig = {
  apiKey: "AIzaSyDXsvsaG8IdcjZv4iG4WHjPneGvcxywuTk",
  authDomain: "bobba-591c5.firebaseapp.com",
  projectId: "bobba-591c5",
  storageBucket: "bobba-591c5.firebasestorage.app",
  messagingSenderId: "839501020120",
  appId: "1:839501020120:web:0e58d4759785a1fadfd0ad",
  measurementId: "G-C3D5TB22F0"
};

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const storage = getStorage(app);

        /**
         * ------------------------------------------------------------------
         * CORE APPLICATION STATE & SERVICES
         * Professional MVC Structure
         * ------------------------------------------------------------------
         */

        const State = {
            user: null, // Current logged in user object
            activeContact: null, // User currently being chatted with
            contactsMap: {}, // Cache of contact data
            peer: null, // PeerJS instance
            currentCall: null, // Active media connection
            localStream: null, // My camera stream
            unsubscribeChat: null, // Listener for messages
            isCalling: false
        };

        // --- UI MANAGER: Handles DOM manipulation, Themes, Toasts ---
        class UIManager {
            constructor() {
                this.dom = {
                    auth: document.getElementById('auth-view'),
                    app: document.getElementById('app-view'),
                    msgArea: document.getElementById('messages-area'),
                    inputArea: document.getElementById('input-area'),
                    contactList: document.getElementById('contacts-list')
                };
            }

            toast(msg, type = 'info') {
                const container = document.getElementById('toast-container');
                const el = document.createElement('div');
                el.className = 'toast';
                el.textContent = msg;
                if(type === 'error') el.style.borderLeft = '4px solid var(--danger)';
                container.appendChild(el);
                
                // Animation frame trick for transition
                requestAnimationFrame(() => {
                    el.classList.add('visible');
                    setTimeout(() => {
                        el.classList.remove('visible');
                        setTimeout(() => el.remove(), 300);
                    }, 3000);
                });
            }

            setLoading(isLoading) {
                // Implementation for spinners if needed
                document.body.style.cursor = isLoading ? 'wait' : 'default';
            }

            toggleTheme() {
                const body = document.body;
                const current = body.getAttribute('data-theme');
                const next = current === 'dark' ? 'light' : 'dark';
                body.setAttribute('data-theme', next);
                localStorage.setItem('theme', next);
            }

            initTheme() {
                const saved = localStorage.getItem('theme') || 'light';
                document.body.setAttribute('data-theme', saved);
            }

            showApp() {
                this.dom.auth.classList.add('hidden');
                this.dom.app.classList.remove('hidden');
                document.getElementById('my-nick').textContent = State.user.nickname;
                document.getElementById('my-avatar').textContent = State.user.nickname[0].toUpperCase();
            }

            showAuth() {
                this.dom.app.classList.add('hidden');
                this.dom.auth.classList.remove('hidden');
            }

            openChatUI(contact) {
                document.body.classList.add('chat-open');
                document.getElementById('chat-name').textContent = contact.nickname;
                document.getElementById('chat-avatar').textContent = contact.nickname[0].toUpperCase();
                this.dom.inputArea.classList.remove('hidden');
                this.dom.msgArea.innerHTML = ''; // Clear previous messages
            }

            closeChat() {
                document.body.classList.remove('chat-open');
                State.activeContact = null;
                if(State.unsubscribeChat) State.unsubscribeChat();
            }
        }

        // --- AUTH SERVICE: Login, Register, Logout ---
        class AuthService {
            constructor() {
                this.isRegistering = false;
            }

            toggleMode() {
                this.isRegistering = !this.isRegistering;
                document.getElementById('btn-auth-action').textContent = this.isRegistering ? 'Create Account' : 'Login';
                document.getElementById('auth-switch-text').textContent = this.isRegistering ? 'Have an account? Login' : 'New here? Create Account';
                document.getElementById('auth-error').style.display = 'none';
            }

            async login() {
                const nick = document.getElementById('auth-nick').value.trim();
                const pass = document.getElementById('auth-pass').value;
                if(!nick || !pass) return App.ui.toast("Please fill all fields", 'error');

                const email = `${nick.toLowerCase().replace(/[^a-z0-9]/g, '')}@familyconnect.app`;

                try {
                    App.ui.setLoading(true);
                    if (this.isRegistering) {
                        // 1. Check uniqueness
                        const q = query(collection(db, "users"), where("nickname", "==", nick));
                        const check = await getDocs(q); // Using imported getDocs below
                        if (!check.empty) throw new Error("Nickname taken");

                        // 2. Create Auth
                        const cred = await createUserWithEmailAndPassword(auth, email, pass);
                        
                        // 3. Create Firestore Doc
                        await setDoc(doc(db, "users", cred.user.uid), {
                            uid: cred.user.uid,
                            nickname: nick,
                            contacts: [],
                            createdAt: serverTimestamp()
                        });
                        await updateProfile(cred.user, { displayName: nick });
                    } else {
                        await signInWithEmailAndPassword(auth, email, pass);
                    }
                } catch (e) {
                    const errDiv = document.getElementById('auth-error');
                    errDiv.style.display = 'block';
                    errDiv.textContent = e.message.replace("Firebase: ", "");
                } finally {
                    App.ui.setLoading(false);
                }
            }

            logout() {
                if(App.call.peer) App.call.peer.destroy();
                signOut(auth);
                window.location.reload();
            }
        }

        // --- CHAT & CONTACTS SERVICE ---
        class ChatService {
            async loadContacts() {
                if(!State.user || !State.user.contacts) return;
                const list = document.getElementById('contacts-list');
                list.innerHTML = '';

                // Firestore 'in' query supports max 10. For production, execute in batches.
                if(State.user.contacts.length === 0) {
                    list.innerHTML = '<div style="padding:20px; text-align:center; opacity:0.6;">Search for family members to add them!</div>';
                    return;
                }

                // Batching logic for scalability (blocks of 10)
                const chunks = [];
                for (let i = 0; i < State.user.contacts.length; i += 10) {
                    chunks.push(State.user.contacts.slice(i, i + 10));
                }

                for (const chunk of chunks) {
                    const q = query(collection(db, "users"), where("uid", "in", chunk));
                    const snap = await getDocs(q); // Need to import getDocs inside module scope or pass it
                    snap.forEach(d => {
                        const contact = d.data();
                        State.contactsMap[contact.uid] = contact;
                        this.renderContactItem(contact);
                    });
                }
            }

            renderContactItem(contact) {
                const list = document.getElementById('contacts-list');
                const div = document.createElement('div');
                div.className = 'contact-item';
                div.innerHTML = `
                    <div class="avatar">${contact.nickname[0].toUpperCase()}</div>
                    <div class="contact-info">
                        <div class="contact-name">${contact.nickname}</div>
                        <div class="contact-status">Tap to chat</div>
                    </div>
                `;
                div.onclick = () => this.startChat(contact);
                list.appendChild(div);
            }

            async searchUser() {
                const input = document.getElementById('contact-search');
                const val = input.value.trim();
                if(!val) return;
                if(val === State.user.nickname) return App.ui.toast("That's you!", 'error');

                App.ui.toast("Searching...");
                const q = query(collection(db, "users"), where("nickname", "==", val));
                const snap = await getDocs(q); // Will define getDocs at bottom for scope
                
                if(snap.empty) {
                    App.ui.toast("User not found", 'error');
                } else {
                    const newUser = snap.docs[0].data();
                    const myRef = doc(db, "users", State.user.uid);
                    
                    // Optimistic update
                    let current = State.user.contacts || [];
                    if(!current.includes(newUser.uid)) {
                        current.push(newUser.uid);
                        await updateDoc(myRef, { contacts: current });
                        State.user.contacts = current;
                        this.renderContactItem(newUser);
                        State.contactsMap[newUser.uid] = newUser;
                        App.ui.toast("Added to contacts!", 'success');
                        input.value = '';
                    } else {
                        App.ui.toast("Already in contacts");
                    }
                }
            }

            startChat(contact) {
                State.activeContact = contact;
                App.ui.openChatUI(contact);

                const chatId = [State.user.uid, contact.uid].sort().join("_");
                const q = query(collection(db, "chats", chatId, "messages"), orderBy("createdAt", "asc"));

                State.unsubscribeChat = onSnapshot(q, (snapshot) => {
                    snapshot.docChanges().forEach((change) => {
                        if (change.type === "added") {
                            this.renderMessage(change.doc.data());
                        }
                    });
                });
            }

            renderMessage(msg) {
                const isMe = msg.senderId === State.user.uid;
                const div = document.createElement('div');
                div.className = `msg ${isMe ? 'msg-out' : 'msg-in'}`;
                
                let content = `<span>${msg.text}</span>`;
                if(msg.type === 'image') {
                    content = `<img src="${msg.fileUrl}" class="msg-img" onclick="window.open('${msg.fileUrl}')">` + content;
                } else if (msg.type === 'file') {
                    content = `<a href="${msg.fileUrl}" target="_blank" style="color:var(--primary); text-decoration:none;"><i class="fas fa-file"></i> File</a><br>` + content;
                }

                const date = msg.createdAt ? msg.createdAt.toDate() : new Date();
                const time = date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});

                div.innerHTML = `${content} <span class="msg-time">${time}</span>`;
                
                const area = document.getElementById('messages-area');
                area.appendChild(div);
                area.scrollTop = area.scrollHeight; // Auto scroll
            }

            async sendMessage(fileData = null) {
                if(!State.activeContact) return;
                const input = document.getElementById('msg-input');
                const text = input.value.trim();
                
                if(!text && !fileData) return;

                const chatId = [State.user.uid, State.activeContact.uid].sort().join("_");
                
                const payload = {
                    text: text,
                    senderId: State.user.uid,
                    createdAt: serverTimestamp(),
                    type: fileData ? fileData.type : 'text',
                    fileUrl: fileData ? fileData.url : null
                };

                await addDoc(collection(db, "chats", chatId, "messages"), payload);
                input.value = '';
            }

            async handleFileUpload(input) {
                const file = input.files[0];
                if(!file) return;
                App.ui.toast("Uploading...");
                
                try {
                    const storageRef = ref(storage, `chat/${Date.now()}_${file.name}`);
                    const snap = await uploadBytes(storageRef, file);
                    const url = await getDownloadURL(snap.ref);
                    const type = file.type.startsWith('image/') ? 'image' : 'file';
                    await this.sendMessage({ url, type });
                } catch(e) {
                    App.ui.toast("Upload failed", 'error');
                }
                input.value = '';
            }
        }

        // --- VIDEO CALL SERVICE (PeerJS + AudioContext) ---
        class CallService {
            constructor() {
                this.audioCtx = null;
                this.oscillator = null;
            }

            init() {
                // PeerID must be URL-safe. Using removed special chars base64 of UID or similar is best.
                // For simplicity: Clean nickname + substring of UID.
                const safeId = `${State.user.nickname.replace(/\W/g, '')}_${State.user.uid.substr(0,5)}`;
                
                // Keep calling logic robust
                this.peer = new Peer(safeId);

                this.peer.on('open', (id) => {
                    console.log('Peer connected: ' + id);
                    // Update user status in DB if needed (Online/Offline)
                });

                this.peer.on('call', (call) => {
                    this.handleIncomingCall(call);
                });

                this.peer.on('error', (err) => {
                    console.error(err);
                    App.ui.toast("Connection Error", 'error');
                    this.endCall();
                });
            }

            // Generate a Ringtone using Web Audio API (No files needed)
            playRing(type = 'incoming') {
                if (!this.audioCtx) this.audioCtx = new (window.AudioContext || window.webkitAudioContext)();
                this.stopRing();

                this.oscillator = this.audioCtx.createOscillator();
                const gainNode = this.audioCtx.createGain();

                this.oscillator.connect(gainNode);
                gainNode.connect(this.audioCtx.destination);

                if (type === 'incoming') {
                    // Classic phone ring pattern
                    this.oscillator.type = 'sine';
                    this.oscillator.frequency.setValueAtTime(800, this.audioCtx.currentTime);
                    gainNode.gain.setValueAtTime(0, this.audioCtx.currentTime);
                    
                    // Modulate volume to create "Ring-Ring"
                    const now = this.audioCtx.currentTime;
                    gainNode.gain.linearRampToValueAtTime(0.5, now + 0.1);
                    gainNode.gain.linearRampToValueAtTime(0, now + 2);
                    
                    this.oscillator.start(now);
                    this.oscillator.stop(now + 2);
                    
                    // Loop
                    this.ringInterval = setInterval(() => {
                         const osc = this.audioCtx.createOscillator();
                         const gn = this.audioCtx.createGain();
                         osc.connect(gn);
                         gn.connect(this.audioCtx.destination);
                         osc.frequency.setValueAtTime(800, this.audioCtx.currentTime);
                         gn.gain.setValueAtTime(0, this.audioCtx.currentTime);
                         gn.gain.linearRampToValueAtTime(0.5, this.audioCtx.currentTime + 0.1);
                         gn.gain.linearRampToValueAtTime(0, this.audioCtx.currentTime + 2);
                         osc.start();
                         osc.stop(this.audioCtx.currentTime + 2);
                    }, 3000);

                } else if (type === 'dialing') {
                    this.oscillator.frequency.setValueAtTime(400, this.audioCtx.currentTime);
                    gainNode.gain.value = 0.1;
                    this.oscillator.start();
                }
            }

            stopRing() {
                if (this.oscillator) {
                    try { this.oscillator.stop(); } catch(e){}
                    this.oscillator = null;
                }
                if (this.ringInterval) clearInterval(this.ringInterval);
            }

            async getStream() {
                try {
                    const stream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
                    State.localStream = stream;
                    document.getElementById('local-video').srcObject = stream;
                    return stream;
                } catch (e) {
                    App.ui.toast("Camera Access Denied", 'error');
                    throw e;
                }
            }

            handleIncomingCall(call) {
                if (State.currentCall) {
                    // Busy? Reject automatically or notify.
                    // For now, auto-reject
                    call.close(); 
                    return;
                }
                
                this.tempCall = call; // Stash call pending acceptance
                
                // Parse caller name from peer ID (Format: Name_UidPart)
                const callerRaw = call.peer.split('_')[0];
                document.getElementById('caller-name').innerText = callerRaw;
                document.getElementById('caller-avatar').innerText = callerRaw[0].toUpperCase();
                
                // Show UI
                document.getElementById('incoming-modal').classList.add('show');
                this.playRing('incoming');
            }

            async acceptCall() {
                this.stopRing();
                document.getElementById('incoming-modal').classList.remove('show');
                
                try {
                    const stream = await this.getStream();
                    this.tempCall.answer(stream);
                    this.setupCallEvents(this.tempCall);
                } catch (e) {
                    this.rejectCall();
                }
            }

            rejectCall() {
                this.stopRing();
                document.getElementById('incoming-modal').classList.remove('show');
                if(this.tempCall) this.tempCall.close();
                this.tempCall = null;
            }

            async startCall() {
                if(!State.activeContact) return;
                
                // Reconstruct Peer ID
                const targetPeerId = `${State.activeContact.nickname.replace(/\W/g, '')}_${State.activeContact.uid.substr(0,5)}`;
                
                try {
                    const stream = await this.getStream();
                    
                    document.getElementById('call-overlay').classList.add('active');
                    document.getElementById('call-status-text').innerText = "Dialing...";
                    this.playRing('dialing');

                    const call = this.peer.call(targetPeerId, stream);
                    this.setupCallEvents(call);

                } catch(e) {
                    console.log(e);
                }
            }

            setupCallEvents(call) {
                State.currentCall = call;
                document.getElementById('call-overlay').classList.add('active');
                
                call.on('stream', (remoteStream) => {
                    this.stopRing();
                    document.getElementById('call-status-text').innerText = "Connected";
                    // wait a bit to hide status
                    setTimeout(() => document.getElementById('call-status-text').style.display = 'none', 3000);
                    
                    document.getElementById('remote-video').srcObject = remoteStream;
                });

                call.on('close', () => this.endCall());
                call.on('error', () => this.endCall());
            }

            endCall() {
                this.stopRing();
                if (State.currentCall) State.currentCall.close();
                if (State.localStream) {
                    State.localStream.getTracks().forEach(t => t.stop());
                }
                
                State.currentCall = null;
                State.localStream = null;
                
                document.getElementById('call-overlay').classList.remove('active');
                document.getElementById('remote-video').srcObject = null;
                document.getElementById('local-video').srcObject = null;
                document.getElementById('call-status-text').style.display = 'block';
            }

            toggleAudio() {
                if(!State.localStream) return;
                const track = State.localStream.getAudioTracks()[0];
                track.enabled = !track.enabled;
                const btn = document.getElementById('btn-mute');
                btn.style.background = track.enabled ? 'rgba(255,255,255,0.2)' : 'var(--danger)';
                btn.innerHTML = track.enabled ? '<i class="fas fa-microphone"></i>' : '<i class="fas fa-microphone-slash"></i>';
            }

            toggleVideo() {
                if(!State.localStream) return;
                const track = State.localStream.getVideoTracks()[0];
                track.enabled = !track.enabled;
                const btn = document.getElementById('btn-cam');
                btn.style.background = track.enabled ? 'rgba(255,255,255,0.2)' : 'var(--danger)';
                btn.innerHTML = track.enabled ? '<i class="fas fa-video"></i>' : '<i class="fas fa-video-slash"></i>';
            }

            async flipCamera() {
                // Mobile only: Switch facingMode
                if(!State.localStream) return;
                const currentTrack = State.localStream.getVideoTracks()[0];
                const currentSettings = currentTrack.getSettings();
                
                // If on desktop, this usually doesn't work well without device enumeration, 
                // but for mobile, this toggles between 'user' and 'environment'.
                const newMode = (currentSettings.facingMode === 'user') ? 'environment' : 'user';
                
                try {
                    const newStream = await navigator.mediaDevices.getUserMedia({
                        video: { facingMode: newMode },
                        audio: true
                    });
                    
                    // Replace track in peer connection
                    const videoTrack = newStream.getVideoTracks()[0];
                    const sender = State.currentCall.peerConnection.getSenders().find(s => s.track.kind === 'video');
                    sender.replaceTrack(videoTrack);
                    
                    // Update local view
                    document.getElementById('local-video').srcObject = newStream;
                    
                    // Stop old tracks
                    State.localStream.getTracks().forEach(t => t.stop());
                    State.localStream = newStream;
                    
                } catch(e) {
                    App.ui.toast("Cannot switch camera");
                }
            }
        }

        // --- IMPORT HELPER ---
        // Need to fetch getDocs from module scope for the Classes to use
        import { getDocs } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";

        // --- MAIN APP INITIALIZATION ---
        const App = {
            auth: new AuthService(),
            chat: new ChatService(),
            call: new CallService(),
            ui: new UIManager(),
            contacts: new ChatService() // Reuse logic
        };

        // Attach to window for HTML events
        window.App = App;

        // Firebase Auth Listener
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                const userDoc = await getDoc(doc(db, "users", user.uid));
                if(userDoc.exists()) {
                    State.user = userDoc.data();
                    App.ui.showApp();
                    App.chat.loadContacts();
                    App.call.init(); // Init PeerJS
                    App.ui.initTheme();
                }
            } else {
                State.user = null;
                App.ui.showAuth();
            }
        });

    </script>
</body>
</html>
